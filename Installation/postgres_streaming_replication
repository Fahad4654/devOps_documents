Streaming Replication with PostgreSQL 12


Prerequisites:
1. Two separate machines Ubuntu 20.04 machines; one referred to as the primary and the other referred to as the replica.
2. Same version of psql in both machine
3. Your firewalls configured to allow HTTP/HTTPS and traffic on port 5432



Steps:

ON BOTH SERVER;

1. sudo apt update

2. sudo apt install pgpool2 postgresql-12-pgpool2 postgresql-contrib

3. sudo nano /etc/postgresql/12/main/postgresql.conf
	edit this in the conf file:
	
	listen_addresses = '*'
	wal_level = replica
	max_wal_senders = 10
4. sudo systemctl restart postgresql

ON MAIN SERVER:

5. sudo -u postgres psql

6. CREATE ROLE test WITH REPLICATION PASSWORD 'testpassword' LOGIN;

7. \q

8. sudo nano /etc/postgresql/12/main/pg_hba.conf
	add this at the ent of the conf file:
	
	host    replication     test    your-replica-IP/32   md5

9. sudo systemctl restart postgresql@12-main

ON REPLICA SERVER:

10. sudo -u postgres psql

11. SHOW data_directory; (copy the directory)
	output: /var/lib/postgresql/12/main
	
12. \q

13. sudo -u postgres rm -r /var/lib/postgresql/12/main

14. sudo -u postgres mkdir /var/lib/postgresql/12/main

15. sudo -u postgres chmod 700 /var/lib/postgresql/12/main

16. sudo -u postgres pg_basebackup -h primary-ip-addr -p 5432 -U test -D /var/lib/postgresql/12/main/ -Fp -Xs -R

17. sudo systemctl restart postgresql@12-main























configure pg_pool:

https://medium.com/@c.ucanefe/pgpool-installation-connection-test-with-python-c2ef7501a174








Open the syslog daemon's configuration file. This file is typically located at /etc/syslog.conf or /etc/rsyslog.conf, depending on your system.

Add a line to specify the location where pgpool-II messages should be logged. For example:
	local0.*    /var/log/pgpool.log

This line tells the syslog daemon to log messages from the local0 facility to the specified file.
Save the changes to the syslog configuration file.
Restart the syslog daemon to apply the changes. The command to restart the syslog daemon may vary depending on your system. For example:
	sudo service syslog restart

Update the log_destination parameter in your pgpool-II configuration file (pgpool.conf) to use syslog:
	log_destination = 'syslog'

Restart the pgpool-II service:
	sudo service pgpool2 restart

Now, pgpool-II should be configured to log messages to the specified syslog facility, and those messages will be directed to the /var/log/syslog.log file. Ensure that the syslog facility and the log file path are correctly configured in both the syslog daemon and the pgpool-II configuration file.
	sudo tail -f /var/log/syslog











sudo pgpool -n &
sudo pgpool -f /usr/local/etc/pgpool.conf -F /usr/local/etc/pcp.conf -m fast stop
